<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orbital Compute Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap');
    :root {
      --bg: #f0e6d3; --surface: #faf6f0; --surface2: #e8dfd0; --surface3: #d8cfc0;
      --border: #c4b8a4; --border-dark: #8a7a62; --text: #2d2518; --muted: #6b5d4a;
      --orbital: #1a8a6a; --ground: #c44a3a; --accent: #3a7ab8; --warning: #d49a22;
      --purple: #7a4ba8; --orange: #d4622a; --pink: #b84a8a;
      --screen-bg: #1a1a18; --screen-glow: #1a8a6a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'IBM Plex Sans', sans-serif; background: var(--bg); color: var(--text); font-size: 13px; }
    .app { display: grid; grid-template-columns: 1fr; min-height: 100vh; }
    .sidebar { display: none; }
    .main { display: flex; flex-direction: column; min-width: 0; }
    
    /* World tab */
    .world-container { width: 100%; height: calc(100vh - 120px); }
    
    /* Sandbox grid */
    .sandbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      padding: 8px;
    }
    .sandbox-section {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 6px;
      padding: 14px;
      box-shadow: 2px 2px 0 var(--border-dark);
    }
    .sandbox-section.derived-section {
      grid-column: span 2;
    }
    @media (max-width: 700px) {
      .sandbox-section.derived-section { grid-column: span 1; }
    }
    .sidebar-header { 
      padding: 16px; 
      border-bottom: 2px solid var(--border-dark); 
      position: sticky; top: 0; 
      background: linear-gradient(180deg, var(--orbital) 0%, #147a5a 100%);
      z-index: 10;
    }
    .sidebar-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #fff; }
    .sidebar-title .badge { font-size: 9px; background: rgba(255,255,255,0.9); color: var(--orbital); padding: 2px 6px; border-radius: 3px; font-weight: 700; }
    .sidebar-subtitle { font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 4px; }
    .sidebar-content { padding: 12px; }
    .section { 
      background: var(--surface); 
      border-radius: 6px; 
      padding: 12px; 
      margin-bottom: 12px; 
      border: 2px solid var(--border);
      box-shadow: 2px 2px 0 var(--border-dark);
    }
    .derived-section { background: var(--surface); border-radius: 6px; padding: 12px; margin-bottom: 12px; border: 2px solid var(--border); box-shadow: 2px 2px 0 var(--border-dark); }
    .derived-section summary { cursor: pointer; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); }
    .derived-section summary::before { content: ''; width: 3px; height: 12px; background: var(--accent); border-radius: 2px; display: inline-block; margin-right: 8px; vertical-align: middle; }
    .derived-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    .derived-item { 
      display: flex; flex-direction: column; padding: 8px; 
      background: var(--screen-bg); 
      border-radius: 4px; 
      border: 2px solid #0a0a08;
    }
    .derived-label { font-size: 10px; color: var(--screen-glow); opacity: 0.7; }
    .derived-value { font-family: 'IBM Plex Mono', monospace; font-size: 14px; font-weight: 600; color: var(--screen-glow); }
    .derived-unit { font-size: 10px; color: var(--screen-glow); opacity: 0.7; }
    .section-title { font-family: 'IBM Plex Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .section-title::before { content: ''; width: 4px; height: 14px; background: var(--orbital); border-radius: 2px; }
    .section-title.ground::before { background: var(--ground); }
    .slider-val.ground { color: var(--ground); }
    input[type="range"].ground::-webkit-slider-thumb { background: var(--ground); }
    .slider-row { margin-bottom: 10px; }
    .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .slider-lbl { font-size: 11px; }
    .slider-val { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--orbital); font-weight: 600; }
    .slider-val .unit { color: var(--muted); font-size: 10px; margin-left: 2px; }
    input[type="range"] { width: 100%; height: 6px; background: var(--border); border-radius: 3px; appearance: none; cursor: pointer; }
    input[type="range"]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 3px; background: var(--orbital); border: 2px solid var(--surface); box-shadow: 1px 1px 0 var(--border-dark); }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-lbl { font-size: 11px; }
    .toggle-group { display: flex; align-items: center; gap: 8px; }
    .toggle { position: relative; width: 36px; height: 20px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-track { position: absolute; cursor: pointer; inset: 0; background: var(--border); border-radius: 4px; transition: 0.2s; border: 1px solid var(--border-dark); }
    .toggle-track::before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background: var(--surface); border-radius: 3px; transition: 0.2s; }
    .toggle input:checked + .toggle-track { background: var(--orbital); }
    .toggle input:checked + .toggle-track::before { transform: translateX(16px); background: #fff; }
    .year-input { width: 78px; background: var(--screen-bg); border: 2px solid #0a0a08; border-radius: 3px; color: var(--screen-glow); font-family: 'IBM Plex Mono', monospace; font-size: 11px; padding: 3px 8px; text-align: center; }
    .year-input:disabled { opacity: 0.4; }
    .toggle-effect { 
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px; 
      color: var(--muted); 
      margin-top: 4px; 
      padding: 2px 6px;
      background: var(--surface2);
      border-radius: 3px;
      display: inline-block;
    }
    .toggle-effect.active { 
      color: #fff;
      background: var(--orbital);
      box-shadow: 0 0 8px rgba(26,138,106,0.4);
    }
    .main { display: flex; flex-direction: column; overflow: hidden; }
    .main-header { 
      padding: 12px 16px; 
      border-bottom: 2px solid var(--border-dark); 
      background: var(--surface); 
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .tabs { display: flex; gap: 4px; flex-wrap: wrap; }
    .tab { 
      padding: 8px 14px; 
      background: var(--surface2); 
      border: 2px solid var(--border);
      border-radius: 4px; 
      color: var(--text); 
      font-size: 11px; font-weight: 500; 
      cursor: pointer; transition: all 0.2s; 
      text-transform: uppercase; letter-spacing: 0.05em;
      box-shadow: 1px 1px 0 var(--border-dark);
    }
    .tab:hover { background: var(--surface); }
    .tab.active { background: var(--orbital); color: #fff; border-color: var(--orbital); box-shadow: none; }
    .header-badges { display: flex; gap: 12px; flex-wrap: wrap; }
    .badge-item { 
      display: flex; align-items: center; gap: 6px; 
      padding: 6px 10px; 
      background: var(--screen-bg); 
      border-radius: 4px; 
      border: 2px solid #0a0a08;
    }
    .badge-label { font-size: 9px; color: var(--screen-glow); opacity: 0.7; text-transform: uppercase; }
    .badge-value { font-family: 'IBM Plex Mono', monospace; font-size: 13px; font-weight: 600; color: var(--screen-glow); }
    .badge-value.orbital { color: var(--screen-glow); }
    .badge-value.warning { color: var(--warning); }
    .main-content { flex: 1; overflow-y: auto; padding: 16px; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 16px; }
    .kpi { 
      background: var(--screen-bg); 
      border: 2px solid #0a0a08; 
      border-radius: 4px; 
      padding: 12px;
    }
    .kpi-label { font-size: 9px; color: var(--screen-glow); opacity: 0.7; text-transform: uppercase; }
    .kpi-value { font-family: 'IBM Plex Mono', monospace; font-size: 18px; font-weight: 600; margin-top: 4px; color: var(--screen-glow); }
    .kpi.orbital .kpi-value { color: var(--screen-glow); }
    .kpi.ground .kpi-value { color: #e85a4a; }
    .kpi.accent .kpi-value { color: #5a9ae8; }
    .kpi.warning .kpi-value { color: var(--warning); }
    .kpi.purple .kpi-value { color: #a87be8; }
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
    .chart-card { 
      background: var(--surface); 
      border: 2px solid var(--border); 
      border-radius: 6px; 
      padding: 14px; 
      min-width: 0;
      box-shadow: 2px 2px 0 var(--border-dark);
    }
    .chart-card.wide { grid-column: span 2; }
    .chart-header { margin-bottom: 10px; }
    .chart-title { font-size: 12px; font-weight: 600; }
    .chart-desc { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .chart-box { height: 200px; min-width: 0; }
    .chart-card.tall .chart-box { height: 280px; }
    .legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px; }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--muted); }
    .legend-dot { width: 10px; height: 10px; border-radius: 2px; }
    .sla-note { font-size: 10px; color: var(--muted); margin-top: 4px; font-style: italic; }
    
    /* Responsive layouts */
    @media (max-width: 1200px) { 
      .charts { grid-template-columns: 1fr; } 
      .chart-card.wide { grid-column: span 1; } 
    }
    @media (max-width: 1000px) {
      .app { grid-template-columns: 220px 1fr; }
      .sidebar-content { padding: 8px; }
      .section { padding: 10px; }
    }
    @media (max-width: 800px) { 
      .app { grid-template-columns: 1fr; } 
      .sidebar { 
        position: relative; 
        height: auto; 
        max-height: 40vh;
        overflow-y: auto;
        border-right: none; 
        border-bottom: 1px solid var(--border); 
      }
      .main { min-width: 0; overflow-x: hidden; }
      .main-content { padding: 10px; overflow-x: auto; }
      .kpis { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .tabs { flex-wrap: wrap; gap: 2px; }
      .tab { padding: 6px 10px; font-size: 10px; }
      .header-badges { display: none; }
      .charts { grid-template-columns: 1fr; gap: 10px; }
      .chart-card { padding: 10px; }
      .chart-box { height: 180px; }
    }
    @media (max-width: 600px) {
      body { font-size: 12px; }
      .sidebar-content { padding: 8px; }
      .section { padding: 10px; margin-bottom: 8px; }
      .slider-row { margin-bottom: 8px; }
      .kpis { grid-template-columns: repeat(2, 1fr); }
      .kpi { padding: 8px; }
      .kpi-value { font-size: 14px; }
      .chart-card { padding: 10px; }
      .chart-box { height: 180px; }
      .chart-card.tall .chart-box { height: 220px; }
      .legend { gap: 8px; }
      .legend-item { font-size: 9px; }
      .tab { padding: 6px 10px; font-size: 10px; }
      .main-header { padding: 8px 12px; }
    }
  </style>
</head>
<body>
<div class="app">
  
  <div class="main">
    <div class="main-header">
      <div class="tabs">
        <button class="tab active" data-tab="world">World</button>
        <button class="tab" data-tab="core">Core</button>
        <button class="tab" data-tab="market">Market</button>
        <button class="tab" data-tab="constraints">Constraints</button>
        <button class="tab" data-tab="physics">Physics</button>
        <button class="tab" data-tab="futures">Futures</button>
        <button class="tab" data-tab="sandbox">Sandbox</button>
      </div>
      <div class="header-badges">
        <div class="badge-item">
          <span class="badge-label">Crossover</span>
          <span class="badge-value orbital" id="badge-crossover">--</span>
        </div>
        <div class="badge-item">
          <span class="badge-label">Fleet 2050</span>
          <span class="badge-value warning" id="badge-fleet50">--</span>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <!-- WORLD TAB -->
      <div class="tab-panel active" data-tab="world">
        <div class="world-container">
          <iframe id="world-iframe" src="orbital-visualization-example.html" style="width: 100%; height: calc(100vh - 120px); border: none; border-radius: 6px;"></iframe>
        </div>

        <!-- LCOC Chart for World Tab -->
        <div class="world-summary" style="padding: 16px;">
          <div class="charts">
            <div class="chart-card wide tall">
              <div class="chart-header">
                <div class="chart-title">LCOC with Uncertainty ($/GPU-hr)</div>
                <div class="chart-desc">Orbital vs Ground market price. Bands = scenario range.</div>
                <div class="sla-note">SLA: 99.9% uptime (8.76 hrs/yr downtime)</div>
              </div>
              <div class="chart-box"><canvas id="c-lcoc-world"></canvas></div>
              <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital (baseline)</div>
                <div class="legend-item"><div class="legend-dot" style="background:rgba(26,138,106,0.3)"></div>Orbital range</div>
                <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Ground (market)</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- CORE TAB -->
      <div class="tab-panel" data-tab="core">
        <div class="kpis">
          <div class="kpi orbital"><div class="kpi-label">Orb 2026</div><div class="kpi-value" id="kpi-orb25">--</div></div>
          <div class="kpi ground"><div class="kpi-label">Gnd 2026</div><div class="kpi-value" id="kpi-gnd25">--</div></div>
          <div class="kpi orbital"><div class="kpi-label">Orb 2030</div><div class="kpi-value" id="kpi-orb30">--</div></div>
          <div class="kpi ground"><div class="kpi-label">Gnd 2030</div><div class="kpi-value" id="kpi-gnd30">--</div></div>
          <div class="kpi orbital"><div class="kpi-label">Orb 2040</div><div class="kpi-value" id="kpi-orb40">--</div></div>
          <div class="kpi ground"><div class="kpi-label">Gnd 2040</div><div class="kpi-value" id="kpi-gnd40">--</div></div>
          <div class="kpi orbital"><div class="kpi-label">Orb 2050</div><div class="kpi-value" id="kpi-orb50">--</div></div>
          <div class="kpi ground"><div class="kpi-label">Gnd 2050</div><div class="kpi-value" id="kpi-gnd50">--</div></div>
        </div>
        <div class="charts">
          <div class="chart-card wide tall">
            <div class="chart-header">
              <div class="chart-title">LCOC with Uncertainty ($/GPU-hr)</div>
              <div class="chart-desc">Orbital vs Ground market price. Bands = scenario range.</div>
              <div class="sla-note">SLA: 99.9% uptime (8.76 hrs/yr downtime)</div>
            </div>
            <div class="chart-box"><canvas id="c-lcoc"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital (baseline)</div>
              <div class="legend-item"><div class="legend-dot" style="background:rgba(26,138,106,0.3)"></div>Orbital range</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Ground (market)</div>
            </div>
          </div>
          <div class="chart-card wide tall">
            <div class="chart-header">
              <div class="chart-title">Inference Cost ($/M tokens, Llama 70B eq.)</div>
              <div class="chart-desc">Orbital vs Ground inference pricing. Same model as LCOC.</div>
            </div>
            <div class="chart-box"><canvas id="c-inference"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital (baseline)</div>
              <div class="legend-item"><div class="legend-dot" style="background:rgba(26,138,106,0.3)"></div>Orbital range</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Ground (market)</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Orbital Fleet (TW)</div>
              <div class="chart-desc">All shells: LEO, MEO, GEO, Cislunar</div>
            </div>
            <div class="chart-box"><canvas id="c-fleet"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>LEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>MEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--warning)"></div>GEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>Cislunar</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Carbon (gCO₂/TFLOP-hr)</div>
              <div class="chart-desc">Orbital = embodied; Ground = grid + embodied</div>
            </div>
            <div class="chart-box"><canvas id="c-carbon"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Ground</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- MARKET TAB -->
      <div class="tab-panel" data-tab="market">
        <div class="kpis">
          <div class="kpi warning"><div class="kpi-label">Peak Premium</div><div class="kpi-value" id="kpi-peakPrem">--</div></div>
          <div class="kpi ground"><div class="kpi-label">Premium 2035</div><div class="kpi-value" id="kpi-prem35">--</div></div>
          <div class="kpi accent"><div class="kpi-label">Unmet 2035</div><div class="kpi-value" id="kpi-unmet35">--</div></div>
        </div>
        <div class="charts">
          <div class="chart-card wide tall">
            <div class="chart-header">
              <div class="chart-title">Supply vs Demand (GW)</div>
              <div class="chart-desc">Gap drives scarcity premium. Orbital-eligible demand = total × eligible share.</div>
            </div>
            <div class="chart-box"><canvas id="c-supplyDemand"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Total Demand</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--muted)"></div>Ground Supply</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Total Supply</div>
            </div>
          </div>
          <div class="chart-card wide">
            <div class="chart-header">
              <div class="chart-title">Scarcity Premium (×)</div>
              <div class="chart-desc">Price multiplier from unmet demand</div>
            </div>
            <div class="chart-box"><canvas id="c-scarcity"></canvas></div>
          </div>
        </div>
      </div>
      
      <!-- CONSTRAINTS TAB -->
      <div class="tab-panel" data-tab="constraints">
        <div class="kpis">
          <div class="kpi accent"><div class="kpi-label">BW Util 2035</div><div class="kpi-value" id="kpi-bwUtil">--</div></div>
          <div class="kpi orbital"><div class="kpi-label">Platforms 2035</div><div class="kpi-value" id="kpi-plat35">--</div></div>
          <div class="kpi purple"><div class="kpi-label">Platforms 2050</div><div class="kpi-value" id="kpi-plat50">--</div></div>
        </div>
        <div class="charts">
          <div class="chart-card wide">
            <div class="chart-header">
              <div class="chart-title">Shell Utilization (%)</div>
              <div class="chart-desc">LEO: 300k, MEO: 50k, GEO: 1.8k, Cislunar: 700k capacity</div>
            </div>
            <div class="chart-box"><canvas id="c-shellUtil"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>LEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>MEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--warning)"></div>GEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>Cislunar</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Bandwidth Utilization (%)</div>
              <div class="chart-desc">Available / needed. Low = stranded capacity.</div>
            </div>
            <div class="chart-box"><canvas id="c-bwUtil"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Bandwidth Capacity (Tbps)</div>
              <div class="chart-desc">Ground segment optical links</div>
            </div>
            <div class="chart-box"><canvas id="c-bandwidth"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Stranded Capex Penalty (×)</div>
              <div class="chart-desc">LCOC multiplier from underutilization</div>
            </div>
            <div class="chart-box"><canvas id="c-stranded"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Radiator Mass (kg/kW)</div>
              <div class="chart-desc">Droplet: 50× lighter thermal system</div>
            </div>
            <div class="chart-box"><canvas id="c-thermal"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Bottleneck Analysis</div>
              <div class="chart-desc">Dominant constraint each period</div>
            </div>
            <div class="chart-box"><canvas id="c-bottleneck"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div>Thermal</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--warning)"></div>Power</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>Bandwidth</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>Orbital Slots</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Demand</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- PHYSICS TAB -->
      <div class="tab-panel" data-tab="physics">
        <div class="kpis">
          <div class="kpi orbital"><div class="kpi-label">LEO Power</div><div class="kpi-value" id="kpi-leo">--</div></div>
          <div class="kpi purple"><div class="kpi-label">Cislunar</div><div class="kpi-value" id="kpi-cis">--</div></div>
          <div class="kpi accent"><div class="kpi-label">Mass 2035</div><div class="kpi-value" id="kpi-mass">--</div></div>
        </div>
        <div class="charts">
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Mass Breakdown (kg)</div>
              <div class="chart-desc">Droplet radiators 50× lighter</div>
            </div>
            <div class="chart-box"><canvas id="c-mass"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--warning)"></div>Solar/Reactor</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>Battery</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Compute</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Radiator</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--muted)"></div>Structure</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Launch Cost ($/kg)</div>
              <div class="chart-desc">Learning curve to $15/kg floor</div>
            </div>
            <div class="chart-box"><canvas id="c-launch"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Compute Efficiency (GFLOPS/W)</div>
              <div class="chart-desc">AI learning rate drives improvement</div>
            </div>
            <div class="chart-box"><canvas id="c-efficiency"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Ground</div>
            </div>
          </div>
          <div class="chart-card wide">
            <div class="chart-header">
              <div class="chart-title">Platform Power by Shell (MW)</div>
              <div class="chart-desc">Fission/fusion enable 10-1000× power jump</div>
            </div>
            <div class="chart-box"><canvas id="c-power"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>LEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>Cislunar</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Specific Power (W/kg)</div>
              <div class="chart-desc">Key figure of merit for orbital</div>
            </div>
            <div class="chart-box"><canvas id="c-specPower"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Power Budget (%)</div>
              <div class="chart-desc">Compute vs thermal vs housekeeping</div>
            </div>
            <div class="chart-box"><canvas id="c-powerBudget"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Compute</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div>Thermal</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--muted)"></div>Housekeeping</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Data Rate per Platform (Gbps)</div>
              <div class="chart-desc">Link budget based on compute output</div>
            </div>
            <div class="chart-box"><canvas id="c-dataRate"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Radiation: Reliability Overhead (%)</div>
              <div class="chart-desc">SEU-driven redundancy by shell (improves with rad-hard tech)</div>
            </div>
            <div class="chart-box"><canvas id="c-reliability"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>LEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--warning)"></div>MEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>GEO</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>Cislunar</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">EROL (Energy Return on Launch)</div>
              <div class="chart-desc">Lifetime energy output vs launch energy</div>
            </div>
            <div class="chart-box"><canvas id="c-erol"></canvas></div>
          </div>
        </div>
      </div>
      
      <!-- FUTURES TAB -->
      <div class="tab-panel" data-tab="futures">
        <div class="kpis">
          <div class="kpi orbital"><div class="kpi-label">Aggressive</div><div class="kpi-value" id="kpi-crossAgg">--</div></div>
          <div class="kpi accent"><div class="kpi-label">Baseline</div><div class="kpi-value" id="kpi-crossBase">--</div></div>
          <div class="kpi ground"><div class="kpi-label">Conservative</div><div class="kpi-value" id="kpi-crossCons">--</div></div>
        </div>
        <div class="charts">
          <div class="chart-card wide tall">
            <div class="chart-header">
              <div class="chart-title">LCOC Scenarios ($/GPU-hr)</div>
              <div class="chart-desc">Deployment ramp timing under different assumptions</div>
            </div>
            <div class="chart-box"><canvas id="c-lcocScenarios"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital (baseline)</div>
              <div class="legend-item"><div class="legend-dot" style="background:rgba(26,138,106,0.3)"></div>Orbital range</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--muted)"></div>Ground (market)</div>
            </div>
          </div>
          <div class="chart-card wide">
            <div class="chart-header">
              <div class="chart-title">Carbon Scenarios (gCO₂/TFLOP-hr)</div>
              <div class="chart-desc">Emissions trajectory under each scenario</div>
            </div>
            <div class="chart-box"><canvas id="c-carbonScenarios"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital (baseline)</div>
              <div class="legend-item"><div class="legend-dot" style="background:rgba(26,138,106,0.3)"></div>Orbital range</div>
            </div>
          </div>
          <div class="chart-card wide">
            <div class="chart-header">
              <div class="chart-title">Efficiency Scenarios (GFLOPS/W)</div>
              <div class="chart-desc">Compute efficiency improvement</div>
            </div>
            <div class="chart-box"><canvas id="c-effScenarios"></canvas></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital (baseline)</div>
              <div class="legend-item"><div class="legend-dot" style="background:rgba(26,138,106,0.3)"></div>Orbital range</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- SANDBOX TAB -->
      <div class="tab-panel" data-tab="sandbox">
        <div class="sandbox-grid">
          <div class="sandbox-section">
            <div class="section-title">Breakthroughs</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Droplet Radiators</span><span class="slider-val"><span id="v-dropletYear">2030</span></span></div>
              <input type="range" id="dropletYear" min="2026" max="2040" value="2030">
              <div class="toggle-effect" id="eff-droplet">50× lighter thermal, MW-class platforms</div>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-lbl">Space Fission</div>
                <div class="toggle-effect" id="eff-fission">10-100× orbital power only</div>
              </div>
              <div class="toggle-group">
                <input type="number" class="year-input" id="year-fission" value="2035" min="2028" max="2050">
                <label class="toggle"><input type="checkbox" id="tog-fission" checked><span class="toggle-track"></span></label>
              </div>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-lbl">Ground SMR Buildout</div>
                <div class="toggle-effect" id="eff-smr">Ground supply +10-25 GW/yr</div>
              </div>
              <div class="toggle-group">
                <input type="number" class="year-input" id="year-smr" value="2032" min="2028" max="2050">
                <label class="toggle"><input type="checkbox" id="tog-smr" checked><span class="toggle-track"></span></label>
              </div>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-lbl">Fusion Power</div>
                <div class="toggle-effect" id="eff-fusion">GW stations, 100× ground</div>
              </div>
              <div class="toggle-group">
                <input type="number" class="year-input" id="year-fusion" value="2045" min="2035" max="2050">
                <label class="toggle"><input type="checkbox" id="tog-fusion"><span class="toggle-track"></span></label>
              </div>
            </div>
          </div>
          
          <div class="sandbox-section">
            <div class="section-title">Thermal</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Emissivity</span><span class="slider-val"><span id="v-emissivity">0.85</span></span></div>
              <input type="range" id="emissivity" min="70" max="95" value="85">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Op Temp</span><span class="slider-val"><span id="v-opTemp">350</span><span class="unit">K</span></span></div>
              <input type="range" id="opTemp" min="300" max="400" value="350">
            </div>
          </div>
          
          <div class="sandbox-section">
            <div class="section-title">Power</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Solar Eff</span><span class="slider-val"><span id="v-solarEff">32</span><span class="unit">%</span></span></div>
              <input type="range" id="solarEff" min="20" max="50" value="32">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Base Power</span><span class="slider-val"><span id="v-basePower">300</span><span class="unit">kW</span></span></div>
              <input type="range" id="basePower" min="100" max="800" value="300">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Compute %</span><span class="slider-val"><span id="v-computeFrac">68</span><span class="unit">%</span></span></div>
              <input type="range" id="computeFrac" min="50" max="80" value="68">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Battery Dens</span><span class="slider-val"><span id="v-battDens">280</span><span class="unit">Wh/kg</span></span></div>
              <input type="range" id="battDens" min="200" max="500" value="280">
            </div>
          </div>
          
          <div class="sandbox-section">
            <div class="section-title">Compute</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Rad Penalty</span><span class="slider-val"><span id="v-radPen">35</span><span class="unit">%</span></span></div>
              <input type="range" id="radPen" min="10" max="60" value="35">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">AI Learn Rate</span><span class="slider-val"><span id="v-aiLearn">20</span><span class="unit">%/yr</span></span></div>
              <input type="range" id="aiLearn" min="5" max="35" value="20">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Sat Lifetime</span><span class="slider-val"><span id="v-satLife">8</span><span class="unit">yrs</span></span></div>
              <input type="range" id="satLife" min="3" max="15" value="8">
            </div>
          </div>
          
          <div class="sandbox-section">
            <div class="section-title">Economics</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Launch $/kg</span><span class="slider-val">$<span id="v-launchCost">1500</span></span></div>
              <input type="range" id="launchCost" min="200" max="2500" value="1500">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Launch Learn</span><span class="slider-val"><span id="v-launchLearn">30</span><span class="unit">%</span></span></div>
              <input type="range" id="launchLearn" min="10" max="50" value="30">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Launch Floor</span><span class="slider-val">$<span id="v-launchFloor">15</span><span class="unit">/kg</span></span></div>
              <input type="range" id="launchFloor" min="5" max="50" value="15">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Mfg Mult</span><span class="slider-val"><span id="v-prodMult">2.5</span><span class="unit">×</span></span></div>
              <input type="range" id="prodMult" min="10" max="50" value="25">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Maint Cost</span><span class="slider-val"><span id="v-maintCost">15</span><span class="unit">%/yr</span></span></div>
              <input type="range" id="maintCost" min="5" max="30" value="15">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">WACC Orbital</span><span class="slider-val"><span id="v-waccOrbital">12</span><span class="unit">%</span></span></div>
              <input type="range" id="waccOrbital" min="6" max="20" value="12">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">WACC Ground</span><span class="slider-val"><span id="v-waccGround">8</span><span class="unit">%</span></span></div>
              <input type="range" id="waccGround" min="4" max="15" value="8">
            </div>
          </div>
          
          <div class="sandbox-section">
            <div class="section-title ground">Ground</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">PUE</span><span class="slider-val ground"><span id="v-groundPue">1.30</span></span></div>
              <input type="range" class="ground" id="groundPue" min="110" max="180" value="130">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Energy Cost</span><span class="slider-val ground">$<span id="v-energyCost">0.065</span><span class="unit">/kWh</span></span></div>
              <input type="range" class="ground" id="energyCost" min="30" max="120" value="65">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Energy Escal</span><span class="slider-val ground"><span id="v-energyEscal">3</span><span class="unit">%/yr</span></span></div>
              <input type="range" class="ground" id="energyEscal" min="0" max="8" value="3">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Queue Delay</span><span class="slider-val ground"><span id="v-interconnect">36</span><span class="unit">mo</span></span></div>
              <input type="range" class="ground" id="interconnect" min="12" max="60" value="36">
            </div>
          </div>
          
          <div class="sandbox-section">
            <div class="section-title">Bandwidth</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">2026 BW</span><span class="slider-val"><span id="v-bandwidth">50</span><span class="unit">Tbps</span></span></div>
              <input type="range" id="bandwidth" min="10" max="200" value="50">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">BW Growth</span><span class="slider-val"><span id="v-bwGrowth">35</span><span class="unit">%/yr</span></span></div>
              <input type="range" id="bwGrowth" min="10" max="60" value="35">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Batch Eligible</span><span class="slider-val"><span id="v-orbitalEligibleShare">35</span><span class="unit">%</span></span></div>
              <input type="range" id="orbitalEligibleShare" min="10" max="80" value="35">
            </div>
          </div>
          
          <div class="sandbox-section">
            <div class="section-title ground">Market</div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">2026 Demand</span><span class="slider-val ground"><span id="v-demand2025">65</span><span class="unit">GW</span></span></div>
              <input type="range" class="ground" id="demand2025" min="20" max="150" value="65">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Demand Growth</span><span class="slider-val ground"><span id="v-demandGrowth">45</span><span class="unit">%/yr</span></span></div>
              <input type="range" class="ground" id="demandGrowth" min="15" max="80" value="45">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">2026 Supply</span><span class="slider-val ground"><span id="v-supply2025">480</span><span class="unit">GW</span></span></div>
              <input type="range" class="ground" id="supply2025" min="200" max="800" value="480">
            </div>
            <div class="slider-row">
              <div class="slider-header"><span class="slider-lbl">Build Rate</span><span class="slider-val ground"><span id="v-supplyGrowth">15</span><span class="unit">GW/yr</span></span></div>
              <input type="range" class="ground" id="supplyGrowth" min="5" max="40" value="15">
            </div>
          </div>
          
          <div class="sandbox-section derived-section">
            <div class="section-title">Derived Values</div>
            <div class="derived-grid">
              <div class="derived-item">
                <span class="derived-label">Rad Power</span>
                <span class="derived-value" id="d-radPower">--</span>
                <span class="derived-unit">W/m²</span>
              </div>
              <div class="derived-item">
                <span class="derived-label">Rad Mass</span>
                <span class="derived-value" id="d-radMass">--</span>
                <span class="derived-unit">kg/MW</span>
              </div>
              <div class="derived-item">
                <span class="derived-label">Launch LEO</span>
                <span class="derived-value" id="d-launchLeo">--</span>
                <span class="derived-unit">$/kg</span>
              </div>
              <div class="derived-item">
                <span class="derived-label">Launch GEO</span>
                <span class="derived-value" id="d-launchGeo">--</span>
                <span class="derived-unit">$/kg</span>
              </div>
              <div class="derived-item">
                <span class="derived-label">Sat Power</span>
                <span class="derived-value" id="d-satPower">--</span>
                <span class="derived-unit">kW</span>
              </div>
              <div class="derived-item">
                <span class="derived-label">Sat Mass</span>
                <span class="derived-value" id="d-satMass">--</span>
                <span class="derived-unit">kg</span>
              </div>
              <div class="derived-item">
                <span class="derived-label">Demand '35</span>
                <span class="derived-value" id="d-demand35">--</span>
                <span class="derived-unit">GW</span>
              </div>
              <div class="derived-item">
                <span class="derived-label">Supply '35</span>
                <span class="derived-value" id="d-supply35">--</span>
                <span class="derived-unit">GW</span>
              </div>
            </div>
          </div>
        </div>

        <!-- LCOC Chart for Sandbox Tab -->
        <div class="sandbox-summary" style="padding: 16px;">
          <div class="charts">
            <div class="chart-card wide tall">
              <div class="chart-header">
                <div class="chart-title">LCOC with Uncertainty ($/GPU-hr)</div>
                <div class="chart-desc">Orbital vs Ground market price. Bands = scenario range.</div>
                <div class="sla-note">SLA: 99.9% uptime (8.76 hrs/yr downtime)</div>
              </div>
              <div class="chart-box"><canvas id="c-lcoc-sandbox"></canvas></div>
              <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:var(--orbital)"></div>Orbital (baseline)</div>
                <div class="legend-item"><div class="legend-dot" style="background:rgba(26,138,106,0.3)"></div>Orbital range</div>
                <div class="legend-item"><div class="legend-dot" style="background:var(--ground)"></div>Ground (market)</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/*
================================================================================
ORBITAL COMPUTE ECONOMICS SIMULATOR
================================================================================

@author  Pranav Myana
@license MIT

A physics-first model for comparing orbital vs terrestrial data center economics
using the Levelized Cost of Compute (LCOC) framework.

Key features:
- First-principles thermal, power, and mass calculations
- Proper capital recovery (WACC/CRF) instead of naive depreciation
- Bandwidth and demand constraints (sellable utilization)
- TID/SEU radiation effects by orbital shell
- Technology breakthroughs: droplet radiators, fission, fusion

The model answers: when does orbital compute become cost-competitive with ground?
================================================================================
*/

// The punchline: Stefan-Boltzmann is the only equation that matters in space cooling
// εσT⁴ - that's it. No convection, no water rights, just physics.
const STEFAN_BOLTZMANN = 5.67e-8;

// 1361 W/m² of free power, no interconnection queue, no permitting
const SOLAR_CONSTANT = 1361;

const YEARS = Array.from({length: 25}, (_, i) => 2026 + i);

// 99.9% uptime = 8.76 hours downtime/year
// This is the SLA we're targeting. Anything less and you can't compete.
const SLA = 0.999;

/*
Shell definitions - here's where it gets interesting.
- tidMult: Total Ionizing Dose - your hardware slowly fries (shields can backfire, remember the armor analogy)
- seuMult: Single Event Upsets - random bit flips, can only fix with redundancy not shielding
- capacity: how many platforms can physically fit without Kessler syndrome
*/
const SHELLS = {
  leo:      { alt: 550,    latency: 3.7,   tidMult: 1.0,  seuMult: 1.0,  capacity: 300000 },  // the goldilocks zone
  meo:      { alt: 10000,  latency: 67,    tidMult: 3.0,  seuMult: 2.5,  capacity: 50000  },  // Van Allen hell
  geo:      { alt: 35786,  latency: 120,   tidMult: 0.6,  seuMult: 0.8,  capacity: 1800   },  // premium real estate, limited slots
  cislunar: { alt: 384400, latency: 1300,  tidMult: 0.4,  seuMult: 1.2,  capacity: 700000 }   // the frontier - GCR but tons of space
};

/*
The knobs. Every slider maps to one of these.
If you don't believe these numbers, tweak them. That's the whole point.
*/
let P = {
  // Breakthroughs - these are the bets
  dropletOn: true, dropletYear: 2030,   // droplet radiators solve the thermal problem
  fissionOn: true, fissionYear: 2035,   // space nuclear unlocks cislunar
  fusionOn: false, fusionYear: 2045,    // moonshot (literally)
  smrOn: true, smrYear: 2032,           // ground nukes - separate from space policy
  
  // Thermal - the biggest engineering challenge
  emissivity: 0.85,    // how good your radiator surface is
  opTemp: 350,         // hotter = more radiation = less mass, but chips hate heat
  
  // Power - you're drowning in it up there
  solarEff: 0.32,      // panel efficiency, improving every year
  basePower: 300,      // platform power before breakthroughs (kW)
  computeFrac: 0.68,   // what % actually goes to GPUs vs everything else
  battDens: 280,       // Wh/kg - matters for eclipse survival
  
  // Compute
  satLife: 8,          // years before TID kills you
  radPen: 0.35,        // radiation efficiency penalty vs ground chips
  aiLearn: 0.20,       // the learning curve that makes this all work
  
  // Launch economics - this is the enviable cost curve
  // Shuttle: $60k/kg → Falcon: $1.5k/kg → Starship: $10-20/kg
  launchCost: 1500,    // today's $/kg
  launchLearn: 0.30,   // 30% cost reduction per doubling (Wright's law)
  launchFloor: 15,     // can't go below propellant costs
  prodMult: 2.5,       // manufacturing scales with launch volume
  
  maintCost: 0.15,     // 15% of capex annually for ops
  
  // Bandwidth - the real bottleneck everyone ignores
  bandwidth: 50,       // Tbps total capacity in 2025
  bwGrowth: 0.35,      // 35%/yr growth (Starlink, Amazon, etc)
  bwCost: 50,          // $50k per Gbps-year
  gbpsPerTflop: 0.0001, // 0.1 Mbps/TFLOP - batch inference, not real-time
  
  // Market sizing - if you don't believe in compute growth, none of this matters
  orbitalEligibleShare: 0.35,  // 35% of workloads can tolerate latency
  
  // Cost of capital - the thing naive models always forget
  // Time is money. LCOC factors that in.
  waccOrbital: 0.12,   // 12% - space is risky
  waccGround: 0.08,    // 8% - hyperscalers have cheap capital
  
  // Ground constraints - this is what we're racing against
  groundPue: 1.30,     // power overhead (cooling, etc)
  energyCost: 0.065,   // $/kWh today
  energyEscal: 0.03,   // prices going up 3%/yr
  interconnect: 36,    // 3-5 year queue compressed to months
  
  // The demand that orbital has to capture
  demand2025: 65,      // GW of compute demand
  demandGrowth: 0.45,  // 45%/yr if you believe the hyperscalers
  supply2025: 480,     // current ground capacity
  supplyGrowth: 0.15   // new ground coming online (GW/yr equiv)
};

let fleetResults = [];

// ============================================
// SCENARIOS - aggressive/baseline/conservative
// This is how you stress-test the model
// ============================================

const SCENARIOS = {
  aggressive:   { learnMult: 1.4, techYearOffset: -3, demandMult: 1.3, launchLearnMult: 1.3 },  // SpaceX executes perfectly
  baseline:     { learnMult: 1.0, techYearOffset: 0,  demandMult: 1.0, launchLearnMult: 1.0 },  // our best guess
  conservative: { learnMult: 0.6, techYearOffset: 5,  demandMult: 0.7, launchLearnMult: 0.7 }   // everything slips
};

function getScenarioParams(scenario) {
  const s = SCENARIOS[scenario];
  return {
    ...P,
    aiLearn: P.aiLearn * s.learnMult,
    launchLearn: P.launchLearn * s.launchLearnMult,
    dropletYear: P.dropletYear + s.techYearOffset,
    fissionYear: P.fissionYear + s.techYearOffset,
    fusionYear: P.fusionYear + s.techYearOffset,
    demandGrowth: P.demandGrowth * s.demandMult
  };
}

// ============================================
// PHYSICS - first principles only
// ============================================

function getLaunchCost(year, params = P, shell = 'leo') {
  const baseCost = Math.max(params.launchFloor, params.launchCost * Math.pow(1 - params.launchLearn, year - 2026));
  // Shell-specific multipliers (higher orbits cost more)
  const shellMult = {
    leo: 1.0,
    meo: 1.3,      // +30% for MEO
    geo: 1.6,      // +60% for GEO
    cislunar: 2.5  // +150% for cislunar
  };
  return baseCost * (shellMult[shell] || 1.0);
}

function getDropletMult(year, params = P) {
  if (!params.dropletOn || year < params.dropletYear) return 1.0;
  const maturity = Math.min(1, (year - params.dropletYear) / 8);
  return 5.0 + maturity * 5.0; // 5-10× thermal rejection improvement
}

function getRadiatorMassPerMW(year, powerKw, params = P) {
  // Emissivity and opTemp affect radiator mass via Stefan-Boltzmann
  // Higher temp = more radiation = less area = less mass
  // Higher emissivity = more radiation = less mass
  
  // Thermal physics scaling (calibrated at 350K, 0.85 emissivity)
  const tempFactor = Math.pow(350 / params.opTemp, 4);
  const emissivityFactor = 0.85 / params.emissivity;
  
  if (!params.dropletOn || year < params.dropletYear) {
    // Conventional: base ~4500 kg/MW at reference conditions
    const baseMass = Math.max(1000, (4500 * tempFactor * emissivityFactor) - (year - 2026) * 30);
    const powerPenalty = 1 + (powerKw / 200) * 0.3;
    return baseMass * powerPenalty;
  }
  // Droplet: ~20 kg/MW base, but still scales with thermal physics
  // Higher temp/emissivity = even less mass needed
  const maturity = Math.min(1, (year - params.dropletYear) / 8);
  const dropletBase = 20 - maturity * 12;
  return dropletBase * tempFactor * emissivityFactor;
}

function getRadiatorPower(year, params = P) {
  // Pure Stefan-Boltzmann physics: W/m² radiated
  // Droplet doesn't change this - it changes mass/area ratio
  return params.emissivity * STEFAN_BOLTZMANN * Math.pow(params.opTemp, 4);
}

function getGroundEfficiency(year, params = P) {
  let eff = 2800;
  for (let y = 2026; y < year; y++) {
    eff *= (1 + Math.max(0.03, params.aiLearn - (y - 2026) * 0.007));
  }
  return eff;
}

function getOrbitalEfficiency(year, params = P) {
  const ground = getGroundEfficiency(year, params);
  const penalty = params.radPen * Math.pow(0.82, year - 2026);
  return ground * (1 - Math.max(0.02, penalty));
}

function getRadPenalty(year, params = P) {
  return Math.max(0.02, params.radPen * Math.pow(0.82, year - 2026));
}

function getBandwidth(year, params = P) {
  return params.bandwidth * Math.pow(1 + params.bwGrowth, year - 2026);
}

// ============================================
// DEMAND & SUPPLY
// ============================================

function getDemand(year, params = P) {
  const t = year - 2026;
  const growth = Math.max(0.25, params.demandGrowth + 0.20 - t * 0.015);
  return params.demand2025 * Math.pow(1 + growth, t);
}

function getGroundSupply(year, params = P) {
  const t = year - 2026;
  const delayYears = params.interconnect / 12;
  const effectiveT = Math.max(0, t - delayYears);
  let baseSupply = params.supply2025 + effectiveT * (params.supplyGrowth * 100);
  
  // SMR boost: DECOUPLED from space fission - independent ground policy
  // SMRs accelerate ground DC builds by +10 GW/yr initially, ramping to +25 GW/yr
  if (params.smrOn) {
    if (year >= params.smrYear) {
      const smrMaturity = Math.min(1, (year - params.smrYear) / 5);
      const smrBoost = (10 + smrMaturity * 15) * (year - params.smrYear);
      baseSupply += smrBoost;
    }
  }
  
  return baseSupply;
}

// ============================================
// PLATFORM POWER - TECH ENABLES SCALING
// ============================================

function getLEOPower(year, params = P) {
  const t = year - 2026;
  const hasDroplet = params.dropletOn && year >= params.dropletYear;
  const hasFission = params.fissionOn && year >= params.fissionYear;
  const hasFusion = params.fusionOn && year >= params.fusionYear;
  
  if (hasFusion) {
    // Fusion: 100-500 MW LEO stations
    return 100000 + Math.min(1, (year - params.fusionYear) / 10) * 400000;
  }
  if (hasFission) {
    // Fission: 5-20 MW
    return 5000 + Math.min(1, (year - params.fissionYear) / 10) * 15000;
  }
  if (hasDroplet) {
    // Droplet IMMEDIATELY enables MW-class: 1.5 MW instant, grows to 5 MW
    const maturity = Math.min(1, (year - params.dropletYear) / 6);
    return 1500 + maturity * 3500; // 1.5 MW → 5 MW
  }
  // Conventional: HARD LIMITED to ~250 kW by thermal (radiators become prohibitively heavy)
  // This is the key constraint that droplet breaks
  return Math.min(250, params.basePower * 0.8 + t * 5);
}

function getCislunarPower(year, params = P) {
  const hasFission = params.fissionOn && year >= params.fissionYear;
  const hasFusion = params.fusionOn && year >= params.fusionYear;
  const hasDroplet = params.dropletOn && year >= params.dropletYear;
  
  if (hasFusion) {
    // Fusion: 500 MW - 2 GW stations
    return 500000 + Math.min(1, (year - params.fusionYear) / 10) * 1500000;
  }
  if (hasFission) {
    // Fission enables cislunar: 50-150 MW
    return 50000 + Math.min(1, (year - params.fissionYear) / 10) * 100000;
  }
  if (hasDroplet && (year - params.dropletYear) >= 5) {
    // Mature droplet can do cislunar at lower power
    return Math.min(30000, 5000 + (year - params.dropletYear - 5) * 5000);
  }
  return 0;
}

// ============================================
// WACC & CRF - Capital Recovery Factor
// ============================================

function getCRF(wacc, years) {
  // Capital Recovery Factor: converts capex to annualized payment
  // CRF = r(1+r)^n / ((1+r)^n - 1)
  if (wacc <= 0 || years <= 0) return 1 / Math.max(1, years);
  const r = wacc;
  const n = years;
  const factor = Math.pow(1 + r, n);
  return (r * factor) / (factor - 1);
}

// ============================================
// RADIATION: TID & SEU Effects by Shell
// ============================================

function getShellRadiationEffects(shell, year, params = P) {
  const shellData = SHELLS[shell];
  const t = year - 2026;
  
  // TID effect: reduces effective lifetime (higher tidMult = shorter life)
  // Base lifetime modified by TID: effectiveLife = satLife / tidMult
  const tidFactor = shellData.tidMult;
  const effectiveLife = params.satLife / tidFactor;
  
  // SEU effect: reliability overhead (redundancy, ECC, spares)
  // seuMult of 1.0 = no overhead, 2.0 = 2× compute needed for same reliable output
  // Improves over time with rad-hard tech (18%/yr improvement)
  const radHardImprovement = Math.pow(0.82, t);
  const seuPenalty = 1 + (shellData.seuMult - 1) * radHardImprovement;
  
  // Availability factor: fraction of compute that's usable after SEU overhead
  const availabilityFactor = 1 / seuPenalty;
  
  // Replacement rate: driven by TID degradation
  const baseReplacement = 1 / effectiveLife;
  const replacementRate = Math.min(0.30, baseReplacement);
  
  return {
    tidFactor,
    effectiveLife,
    seuPenalty,
    availabilityFactor,
    replacementRate
  };
}

// Get reliability overhead for all shells (for charting)
function getAllShellReliability(year, params = P) {
  return {
    leo: getShellRadiationEffects('leo', year, params),
    meo: getShellRadiationEffects('meo', year, params),
    geo: getShellRadiationEffects('geo', year, params),
    cislunar: getShellRadiationEffects('cislunar', year, params)
  };
}

// ============================================
// SATELLITE ECONOMICS
// This is the LCOC calculation - the whole point of the model
// ============================================

function calcSatellite(year, params = P, shell = 'leo') {
  const t = year - 2026;
  const hasDroplet = params.dropletOn && year >= params.dropletYear;
  const hasFission = params.fissionOn && year >= params.fissionYear;
  const hasFusion = params.fusionOn && year >= params.fusionYear;
  
  // Platform specs - these all compound
  const powerKw = getLEOPower(year, params);
  const solarEff = Math.min(0.50, params.solarEff + t * 0.008);
  const radPower = getRadiatorPower(year, params);
  const gflopsW = getOrbitalEfficiency(year, params);  // the learning curve
  const launchCost = getLaunchCost(year, params, shell);  // the cost curve
  const prodMult = Math.max(0.25, params.prodMult * Math.pow(0.68, t));  // manufacturing scale
  const radMassPerMW = getRadiatorMassPerMW(year, powerKw, params);
  
  // Radiation - the thing everyone asks about
  const radEffects = getShellRadiationEffects(shell, year, params);
  
  // Power source mass - this is where fission/fusion change everything
  let powerMass = 0, battMass = 0;
  if (hasFusion) {
    powerMass = powerKw * 0.004;  // 250 W/kg - physics says this is possible
  } else if (hasFission) {
    powerMass = powerKw * 0.010;  // 100 W/kg - Kilopower-class
  } else {
    // Solar: area * areal density
    const panelArea = powerKw * 1000 / (solarEff * SOLAR_CONSTANT);
    powerMass = panelArea * 1.2;
    // Batteries for eclipse - energy density matters
    const battDens = Math.min(1000, params.battDens + t * 35);
    battMass = powerKw * 0.05 * 1.5 * 1000 / battDens;
  }
  
  // Compute - apply SEU reliability overhead (the bit flips)
  const computeKw = powerKw * params.computeFrac;
  const rawTflops = computeKw * gflopsW / 1000;
  // SEU means you need redundancy - can't shield against it
  const tflops = rawTflops * radEffects.availabilityFactor;
  const gpuEq = tflops / 1979;  // H100 equivalents
  const compMass = Math.max(3, rawTflops * 0.0002);
  
  // Thermal - THE constraint pre-droplet
  // Every watt becomes heat, heat needs radiators, radiators are heavy
  const wasteKw = computeKw * 0.65;
  const radMass = wasteKw / 1000 * radMassPerMW;
  
  // Total mass - structure, margin, everything
  const subsystems = powerMass + battMass + compMass + radMass + 25;
  const dryMass = subsystems * 1.10;  // 10% structural margin
  
  // Specific power - the metric that shows orbital advantage
  const specPower = powerKw * 1000 / dryMass;
  
  const solarArea = hasFission || hasFusion ? 0 : powerKw * 1000 / (solarEff * SOLAR_CONSTANT);
  const dataRateGbps = tflops * params.gbpsPerTflop;
  
  /*
  LCOC calculation - here's the punchline
  
  Naive metrics: $/GPU-hour at a moment
  LCOC: $/delivered-GPU-hour over the asset's life, accounting for:
    - Time value of money (WACC)
    - Capital recovery (CRF amortization)
    - Maintenance and ops
    - Actual utilization (SLA)
  
  This is apples-to-apples for radically different architectures.
  */
  const capex = dryMass * launchCost + dryMass * 350 * prodMult + 15000 * prodMult;
  const crf = getCRF(params.waccOrbital, radEffects.effectiveLife);
  const annualCapex = capex * crf;  // proper annualized, not naive depreciation
  const annualMaint = capex * params.maintCost;
  const annual = annualCapex + annualMaint;
  const gpuHrs = gpuEq * 8760 * SLA;  // actual delivered compute-hours
  const lcoc = gpuHrs > 0 ? annual / gpuHrs : Infinity;
  
  // Carbon intensity - grams CO2 per TFLOP-hour
  const carbonKg = dryMass * 95;  // embodied carbon in manufacturing
  const carbonPerTflop = carbonKg * 1000 / Math.max(1, tflops * 8760 * radEffects.effectiveLife * 0.88);
  
  // EROL: Energy Return on Launch - is it worth launching?
  const erol = (powerKw * 1000 * 8760 * 3600 * radEffects.effectiveLife * 0.88) / (dryMass * 400e6);
  
  return {
    year, powerKw, dryMass, tflops, gpuEq, capex, lcoc, erol, carbonPerTflop, gflopsW, radPower,
    specPower, solarArea, dataRateGbps, shell,
    mass: { power: powerMass, batt: battMass, comp: compMass, rad: radMass, struct: subsystems * 0.10 },
    hasDroplet, hasFission, hasFusion, radMassPerMW,
    radEffects // Include radiation effects in output
  };
}

// ============================================
// GROUND CALCULATION
// ============================================

function calcGround(year, orbitalSupplyGW = 0, params = P) {
  const t = year - 2026;
  const gflopsW = getGroundEfficiency(year, params);
  
  // SMR synergy: DECOUPLED from space fission - independent ground policy
  const hasSmr = params.smrOn && year >= params.smrYear;
  const smrDiscount = hasSmr ? 0.7 - Math.min(0.3, (year - params.smrYear) * 0.03) : 1.0;
  
  // Hardware cost with WACC/CRF
  const gpuPrice = 25000 * Math.pow(0.84, t);
  const hwCapex = (gpuPrice / 3) / (gflopsW / 2800);
  const groundHwLife = 5; // 5 year hardware refresh cycle
  const crfGround = getCRF(params.waccGround, groundHwLife);
  const hwCost = hwCapex * crfGround; // Annualized hardware cost
  
  // Energy cost with escalation and SMR discount
  const energy = params.energyCost * Math.pow(1 + params.energyEscal, t) * smrDiscount;
  const pue = Math.max(1.08, params.groundPue - t * 0.01);
  const enCost = 700 * 8760 * SLA * energy * pue / 1000;
  const overhead = 0.20 * 8760 * SLA;
  const base = (hwCost + enCost + overhead) / (8760 * SLA);
  
  const demand = getDemand(year, params);
  const groundSupply = getGroundSupply(year, params);
  const totalSupply = groundSupply + orbitalSupplyGW;
  const unmetRatio = Math.max(0, (demand - totalSupply) / totalSupply);
  
  let premium;
  if (unmetRatio <= 0) premium = 1.0;
  else if (unmetRatio <= 0.5) premium = 1 + unmetRatio * 8;
  else if (unmetRatio <= 2) premium = 5 + (unmetRatio - 0.5) * 20;
  else premium = 35 + (unmetRatio - 2) * 15;
  
  const gridCarbon = 380 * Math.pow(0.97, t);
  // Carbon calculation (dimensionally correct)
  // gridCarbon: gCO2/kWh
  // gflopsW: GFLOP/s per W
  // For 1 TFLOP-hr: need (1000/gflopsW) W for 1 hr = (1/gflopsW) kWh
  // With PUE: (pue/gflopsW) kWh
  // Carbon: gridCarbon * (pue / gflopsW) gCO2/TFLOP-hr
  const carbonPerTflop = gridCarbon * (pue / gflopsW) + 5;
  
  return { year, base, market: base * premium, premium, carbonPerTflop, gflopsW, demand, groundSupply, totalSupply, unmetRatio };
}

// ============================================
// FLEET CALCULATION - MULTI-SHELL
// ============================================

function calcFleet(year, crossoverYear = null, params = P) {
  const sat = calcSatellite(year, params);
  const cislunarPowerKw = getCislunarPower(year, params);
  const t = year - 2026;
  
  const hasFission = params.fissionOn && year >= params.fissionYear;
  const hasFusion = params.fusionOn && year >= params.fusionYear;
  const hasDroplet = params.dropletOn && year >= params.dropletYear;
  
  let leoPlatforms = 0, meoPlatforms = 0, geoPlatforms = 0, cisPlatforms = 0;
  
  if (!crossoverYear || year < crossoverYear) {
    // Pre-crossover: minimal early adopters
    leoPlatforms = Math.min(500, 50 + t * 20);
  } else {
    const yearsPost = year - crossoverYear;
    
    // LEO fills first and fastest - doubles every 1.2 years
    leoPlatforms = Math.min(SHELLS.leo.capacity, Math.round(500 * Math.pow(2, yearsPost / 1.2)));
    
    // MEO: High radiation, slower growth - starts year 2
    if (yearsPost >= 2) {
      meoPlatforms = Math.min(SHELLS.meo.capacity, Math.round(100 * Math.pow(1.8, (yearsPost - 2) / 1.5)));
    }
    
    // GEO: Limited slots, premium location - starts year 3
    if (yearsPost >= 3) {
      geoPlatforms = Math.min(SHELLS.geo.capacity, Math.round(50 * Math.pow(1.5, (yearsPost - 3) / 2)));
    }
    
    // Cislunar: Requires fission/fusion - starts year 2
    if (cislunarPowerKw > 0 && yearsPost >= 2) {
      cisPlatforms = Math.min(SHELLS.cislunar.capacity, Math.round(50 * Math.pow(2, (yearsPost - 2) / 2)));
    }
  }
  
  // === Power by shell ===
  // GEO can have much larger platforms (stable orbit, no drag)
  const geoPowerKw = hasFission ? sat.powerKw * 20 : (hasDroplet ? sat.powerKw * 10 : sat.powerKw * 5);
  
  const leoPowerTw = leoPlatforms * sat.powerKw / 1e9;
  const meoPowerTw = meoPlatforms * sat.powerKw * 0.8 / 1e9; // MEO Van Allen penalty
  const geoPowerTw = geoPlatforms * geoPowerKw / 1e9;
  const cisPowerTw = cisPlatforms * cislunarPowerKw / 1e9;
  const totalPowerTw = leoPowerTw + meoPowerTw + geoPowerTw + cisPowerTw;
  
  // === Bandwidth utilization ===
  const geoTflopsPerPlatform = geoPowerKw * params.computeFrac * sat.gflopsW / 1000;
  const cisTflopsPerPlatform = cislunarPowerKw * params.computeFrac * sat.gflopsW / 1000;
  
  const fleetTflops = leoPlatforms * sat.tflops + 
                      meoPlatforms * sat.tflops * 0.8 +
                      geoPlatforms * geoTflopsPerPlatform +
                      cisPlatforms * cisTflopsPerPlatform;
  
  const bwNeededGbps = fleetTflops * params.gbpsPerTflop;
  const bwAvailTbps = getBandwidth(year, params);
  const bwAvailGbps = bwAvailTbps * 1000;
  
  // bwSell: fraction of compute you can actually monetize (sellable utilization)
  const bwSell = (bwNeededGbps <= 0) ? 1 : Math.min(1, bwAvailGbps / bwNeededGbps);
  
  // === Demand constraint ===
  // Only orbitalEligibleShare of total demand is batch/latency-tolerant
  const totalDemandGW = getDemand(year, params);
  const eligibleDemandGW = totalDemandGW * params.orbitalEligibleShare;
  const fleetPowerGW = totalPowerTw * 1000;
  
  // demandSell: fraction of fleet capacity the market can absorb
  const demandSell = (fleetPowerGW <= 0) ? 1 : Math.min(1, eligibleDemandGW / fleetPowerGW);
  
  // Effective LCOC: inflated by whichever constraint binds (stranded capex)
  const sellableUtil = Math.min(bwSell, demandSell);
  const lcocEffective = sat.lcoc / Math.max(0.01, sellableUtil);
  
  // For display
  const bwUtil = bwAvailGbps > 0 ? Math.min(1, bwNeededGbps / bwAvailGbps) : 1;
  const demandUtil = eligibleDemandGW > 0 ? Math.min(1, fleetPowerGW / eligibleDemandGW) : 0;
  
  // Shell utilization
  const leoUtil = leoPlatforms / SHELLS.leo.capacity;
  const meoUtil = meoPlatforms / SHELLS.meo.capacity;
  const geoUtil = geoPlatforms / SHELLS.geo.capacity;
  const cisUtil = cisPlatforms / SHELLS.cislunar.capacity;
  
  // Bottleneck detection
  let bottleneck = 'thermal';
  if (!crossoverYear || year < crossoverYear) {
    bottleneck = 'thermal';
  } else {
    if (bwSell < demandSell && bwSell < 0.9) bottleneck = 'bandwidth';
    else if (demandSell < 0.9) bottleneck = 'demand';
    else if (leoUtil > 0.9 || geoUtil > 0.9) bottleneck = 'slots';
    else if (!hasDroplet && !hasFission) bottleneck = 'thermal';
    else bottleneck = 'power';
  }
  
  const leoRadEffects = getShellRadiationEffects('leo', year, params);
  const replacementRate = leoRadEffects.replacementRate;
  
  return {
    year, 
    leoPlatforms, meoPlatforms, geoPlatforms, cisPlatforms,
    leoPowerTw, meoPowerTw, geoPowerTw, cisPowerTw, totalPowerTw,
    lcocEffective, bwUtil, bwAvailGbps, bwNeededGbps, bwSell,
    demandUtil, demandSell, eligibleDemandGW, fleetTflops, sellableUtil,
    satPowerKw: sat.powerKw, cislunarPowerKw,
    leoUtil, meoUtil, geoUtil, cisUtil, 
    bottleneck, replacementRate
  };
}

// ============================================
// SCENARIO RUNNER
// ============================================

function runScenario(scenario) {
  const params = getScenarioParams(scenario);
  const sats = YEARS.map(y => calcSatellite(y, params));
  const preFleets = YEARS.map(y => calcFleet(y, null, params));
  const preGnds = YEARS.map(y => calcGround(y, 0, params));
  
  const crossIdx = preFleets.findIndex((f, i) => f.lcocEffective < preGnds[i].market);
  const crossoverYear = crossIdx >= 0 ? YEARS[crossIdx] : null;
  
  const fleets = YEARS.map(y => calcFleet(y, crossoverYear, params));
  const gnds = YEARS.map((y, i) => calcGround(y, fleets[i].totalPowerTw * 1000, params));
  
  return { sats, fleets, gnds, crossoverYear };
}

// ============================================
// CHARTS
// ============================================

Chart.defaults.color = '#6b5d4a';
Chart.defaults.borderColor = '#c4b8a4';
Chart.defaults.font.family = 'IBM Plex Sans';

let charts = {};

function initCharts() {
  const opts = (yLabel, log = false) => ({
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: { y: { type: log ? 'logarithmic' : 'linear', title: { display: true, text: yLabel } } }
  });
  const stackOpts = (yLabel) => ({
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: yLabel } } }
  });
  
  // Core - LCOC with uncertainty bands
  charts.lcoc = new Chart(document.getElementById('c-lcoc'), {
    type: 'line', data: { labels: YEARS, datasets: [
      // Aggressive bound (upper for uncertainty)
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
      // Baseline orbital
      { data: [], borderColor: '#1a8a6a', borderWidth: 2, tension: 0.3, pointRadius: 0 },
      // Conservative bound (lower)
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '-1', tension: 0.3, pointRadius: 0 },
      // Ground market
      { data: [], borderColor: '#c44a3a', borderWidth: 2, tension: 0.3, pointRadius: 0 }
    ]}, options: opts('$/GPU-hr', true)
  });

  // World tab LCOC chart (duplicate for World tab)
  charts.lcocWorld = new Chart(document.getElementById('c-lcoc-world'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
      { data: [], borderColor: '#1a8a6a', borderWidth: 2, tension: 0.3, pointRadius: 0 },
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '-1', tension: 0.3, pointRadius: 0 },
      { data: [], borderColor: '#c44a3a', borderWidth: 2, tension: 0.3, pointRadius: 0 }
    ]}, options: opts('$/GPU-hr', true)
  });

  // Sandbox tab LCOC chart (duplicate for Sandbox tab)
  charts.lcocSandbox = new Chart(document.getElementById('c-lcoc-sandbox'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
      { data: [], borderColor: '#1a8a6a', borderWidth: 2, tension: 0.3, pointRadius: 0 },
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '-1', tension: 0.3, pointRadius: 0 },
      { data: [], borderColor: '#c44a3a', borderWidth: 2, tension: 0.3, pointRadius: 0 }
    ]}, options: opts('$/GPU-hr', true)
  });

  // Inference cost ($/M tokens, Llama 70B equivalent)
  charts.inference = new Chart(document.getElementById('c-inference'), {
    type: 'line', data: { labels: YEARS, datasets: [
      // Aggressive bound (upper for uncertainty)
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
      // Baseline orbital
      { data: [], borderColor: '#1a8a6a', borderWidth: 2, tension: 0.3, pointRadius: 0 },
      // Conservative bound (lower)
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '-1', tension: 0.3, pointRadius: 0 },
      // Ground market
      { data: [], borderColor: '#c44a3a', borderWidth: 2, tension: 0.3, pointRadius: 0 }
    ]}, options: opts('$/M tokens', true)
  });
  
  // Fleet by shell - stacked area chart
  charts.fleet = new Chart(document.getElementById('c-fleet'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#1a8a6a', backgroundColor: 'rgba(26,138,106,0.5)', fill: true, tension: 0.3 },
      { data: [], borderColor: '#3a7ab8', backgroundColor: 'rgba(58,122,184,0.5)', fill: true, tension: 0.3 },
      { data: [], borderColor: '#d49a22', backgroundColor: 'rgba(212,154,34,0.5)', fill: true, tension: 0.3 },
      { data: [], borderColor: '#7a4ba8', backgroundColor: 'rgba(122,75,168,0.5)', fill: true, tension: 0.3 }
    ]}, options: {
      ...opts('TW', true),
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
  
  charts.carbon = new Chart(document.getElementById('c-carbon'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#1a8a6a', tension: 0.3 },
      { data: [], borderColor: '#c44a3a', tension: 0.3 }
    ]}, options: opts('gCO₂/TFLOP-hr')
  });
  
  // Market
  charts.supplyDemand = new Chart(document.getElementById('c-supplyDemand'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#c44a3a', tension: 0.3, borderWidth: 2 },
      { data: [], borderColor: '#7a7a88', borderDash: [4,4], tension: 0.3 },
      { data: [], borderColor: '#1a8a6a', tension: 0.3, borderWidth: 2 }
    ]}, options: opts('GW', true)
  });
  
  charts.scarcity = new Chart(document.getElementById('c-scarcity'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#c44a3a', backgroundColor: 'rgba(196,74,58,0.1)', fill: true, tension: 0.3 }
    ]}, options: opts('×')
  });
  
  charts.efficiency = new Chart(document.getElementById('c-efficiency'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#1a8a6a', tension: 0.3 },
      { data: [], borderColor: '#c44a3a', tension: 0.3 }
    ]}, options: opts('GFLOPS/W', true)
  });
  
  // Constraints - Shell utilization for all 4 shells
  charts.shellUtil = new Chart(document.getElementById('c-shellUtil'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#1a8a6a', tension: 0.3 },
      { data: [], borderColor: '#3a7ab8', tension: 0.3 },
      { data: [], borderColor: '#d49a22', tension: 0.3 },
      { data: [], borderColor: '#7a4ba8', tension: 0.3 }
    ]}, options: opts('%')
  });
  
  charts.bandwidth = new Chart(document.getElementById('c-bandwidth'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#3a7ab8', backgroundColor: 'rgba(58,122,184,0.1)', fill: true, tension: 0.3 }
    ]}, options: opts('Tbps', true)
  });
  
  charts.bwUtil = new Chart(document.getElementById('c-bwUtil'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#d4622a', backgroundColor: 'rgba(212,98,42,0.1)', fill: true, tension: 0.3 }
    ]}, options: opts('%')
  });
  
  // Stranded capex penalty (LCOC multiplier from underutilization)
  charts.stranded = new Chart(document.getElementById('c-stranded'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#c44a3a', backgroundColor: 'rgba(196,74,58,0.1)', fill: true, tension: 0.3 }
    ]}, options: opts('×')
  });
  
  charts.thermal = new Chart(document.getElementById('c-thermal'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#c44a3a', backgroundColor: 'rgba(196,74,58,0.1)', fill: true, tension: 0.1 }
    ]}, options: opts('kg/kW')
  });
  
  charts.erol = new Chart(document.getElementById('c-erol'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#d49a22', backgroundColor: 'rgba(212,154,34,0.1)', fill: true, tension: 0.3 }
    ]}, options: opts('×')
  });
  
  charts.bottleneck = new Chart(document.getElementById('c-bottleneck'), {
    type: 'bar', data: { labels: YEARS, datasets: [
      { data: [], backgroundColor: 'rgba(212,98,42,0.7)' },  // Thermal - orange
      { data: [], backgroundColor: 'rgba(212,154,34,0.7)' },  // Power - yellow
      { data: [], backgroundColor: 'rgba(58,122,184,0.7)' },  // Bandwidth - blue
      { data: [], backgroundColor: 'rgba(122,75,168,0.7)' }, // Slots - purple
      { data: [], backgroundColor: 'rgba(26,138,106,0.7)' }    // Demand - teal
    ]}, options: stackOpts('Constraint')
  });
  
  // Physics
  charts.power = new Chart(document.getElementById('c-power'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#1a8a6a', tension: 0.1, borderWidth: 2 },
      { data: [], borderColor: '#7a4ba8', tension: 0.1, borderWidth: 2 }
    ]}, options: opts('MW', true)
  });
  
  charts.specPower = new Chart(document.getElementById('c-specPower'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#1a8a6a', backgroundColor: 'rgba(26,138,106,0.1)', fill: true, tension: 0.3 }
    ]}, options: opts('W/kg', true)
  });
  
  charts.mass = new Chart(document.getElementById('c-mass'), {
    type: 'bar', data: { labels: YEARS, datasets: [
      { data: [], backgroundColor: '#d49a22' },
      { data: [], backgroundColor: '#7a4ba8' },
      { data: [], backgroundColor: '#1a8a6a' },
      { data: [], backgroundColor: '#c44a3a' },
      { data: [], backgroundColor: '#7a7a88' }
    ]}, options: stackOpts('kg')
  });
  
  charts.powerBudget = new Chart(document.getElementById('c-powerBudget'), {
    type: 'bar', data: { labels: YEARS, datasets: [
      { data: [], backgroundColor: 'rgba(26,138,106,0.7)' },     // Compute - teal
      { data: [], backgroundColor: 'rgba(212,98,42,0.7)' },    // Thermal - orange
      { data: [], backgroundColor: 'rgba(122,122,136,0.7)' }    // Housekeeping - gray
    ]}, options: stackOpts('%')
  });
  
  charts.launch = new Chart(document.getElementById('c-launch'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#d4622a', tension: 0.3 }
    ]}, options: opts('$/kg', true)
  });
  
  charts.dataRate = new Chart(document.getElementById('c-dataRate'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#3a7ab8', backgroundColor: 'rgba(58,122,184,0.1)', fill: true, tension: 0.3 }
    ]}, options: opts('Gbps', true)
  });
  
  // Reliability overhead by shell (SEU penalty)
  charts.reliability = new Chart(document.getElementById('c-reliability'), {
    type: 'line', data: { labels: YEARS, datasets: [
      { data: [], borderColor: '#1a8a6a', tension: 0.3, borderWidth: 2 }, // LEO
      { data: [], borderColor: '#d49a22', tension: 0.3, borderWidth: 2 }, // MEO
      { data: [], borderColor: '#3a7ab8', tension: 0.3, borderWidth: 2 }, // GEO
      { data: [], borderColor: '#7a4ba8', tension: 0.3, borderWidth: 2 }  // Cislunar
    ]}, options: opts('%')
  });
  
  // Futures - with uncertainty bands
  charts.lcocScenarios = new Chart(document.getElementById('c-lcocScenarios'), {
    type: 'line', data: { labels: YEARS, datasets: [
      // Aggressive bound (upper)
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
      // Baseline orbital
      { data: [], borderColor: '#1a8a6a', borderWidth: 2, tension: 0.3, pointRadius: 0 },
      // Conservative bound (lower)
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '-1', tension: 0.3, pointRadius: 0 },
      // Ground market
      { data: [], borderColor: '#7a7a88', borderDash: [4,4], borderWidth: 2, tension: 0.3, pointRadius: 0 }
    ]}, options: opts('$/GPU-hr', true)
  });
  
  charts.carbonScenarios = new Chart(document.getElementById('c-carbonScenarios'), {
    type: 'line', data: { labels: YEARS, datasets: [
      // Aggressive bound
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
      // Baseline
      { data: [], borderColor: '#1a8a6a', borderWidth: 2, tension: 0.3, pointRadius: 0 },
      // Conservative bound
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '-1', tension: 0.3, pointRadius: 0 }
    ]}, options: opts('gCO₂/TFLOP-hr')
  });
  
  charts.effScenarios = new Chart(document.getElementById('c-effScenarios'), {
    type: 'line', data: { labels: YEARS, datasets: [
      // Aggressive bound
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
      // Baseline
      { data: [], borderColor: '#1a8a6a', borderWidth: 2, tension: 0.3, pointRadius: 0 },
      // Conservative bound
      { data: [], borderColor: 'transparent', backgroundColor: 'rgba(26,138,106,0.2)', fill: '-1', tension: 0.3, pointRadius: 0 }
    ]}, options: opts('GFLOPS/W', true)
  });
}

function update() {
  // Run all scenarios
  const agg = runScenario('aggressive');
  const base = runScenario('baseline');
  const cons = runScenario('conservative');
  
  // Use baseline for main display
  const sats = base.sats;
  const gnds = base.gnds;
  fleetResults = base.fleets;
  const crossoverYear = base.crossoverYear;
  
  const i30 = 4, i35 = 9, i40 = 14, i50 = 24; // 2026 start: 2030=4, 2035=9, 2040=14, 2050=24
  
  // Header badges
  document.getElementById('badge-crossover').textContent = crossoverYear || 'Never';
  document.getElementById('badge-fleet50').textContent = fleetResults[i50].totalPowerTw.toFixed(1) + ' TW';
  
  // Core KPIs
  const i26 = 0; // 2026 (first year)
  document.getElementById('kpi-orb25').textContent = '$' + fleetResults[i26].lcocEffective.toFixed(2);
  document.getElementById('kpi-gnd25').textContent = '$' + gnds[i26].market.toFixed(2);
  document.getElementById('kpi-orb30').textContent = '$' + fleetResults[i30].lcocEffective.toFixed(2);
  document.getElementById('kpi-gnd30').textContent = '$' + gnds[i30].market.toFixed(2);
  document.getElementById('kpi-orb40').textContent = '$' + fleetResults[i40].lcocEffective.toFixed(2);
  document.getElementById('kpi-gnd40').textContent = '$' + gnds[i40].market.toFixed(2);
  document.getElementById('kpi-orb50').textContent = '$' + fleetResults[i50].lcocEffective.toFixed(3);
  document.getElementById('kpi-gnd50').textContent = '$' + gnds[i50].market.toFixed(2);
  
  // Derived values
  const radPower = P.emissivity * STEFAN_BOLTZMANN * Math.pow(P.opTemp, 4);
  document.getElementById('d-radPower').textContent = radPower.toFixed(0);
  document.getElementById('d-radMass').textContent = sats[i30].radMassPerMW.toFixed(0);
  document.getElementById('d-launchLeo').textContent = getLaunchCost(2030, P, 'leo').toFixed(0);
  document.getElementById('d-launchGeo').textContent = getLaunchCost(2030, P, 'geo').toFixed(0);
  document.getElementById('d-satPower').textContent = sats[i30].powerKw.toFixed(0);
  document.getElementById('d-satMass').textContent = sats[i30].dryMass.toFixed(0);
  document.getElementById('d-demand35').textContent = gnds[i35].demand.toFixed(0);
  document.getElementById('d-supply35').textContent = gnds[i35].groundSupply.toFixed(0);
  
  // Market KPIs
  document.getElementById('kpi-peakPrem').textContent = Math.max(...gnds.map(g => g.premium)).toFixed(1) + '×';
  document.getElementById('kpi-prem35').textContent = gnds[i35].premium.toFixed(1) + '×';
  document.getElementById('kpi-unmet35').textContent = (gnds[i35].unmetRatio * 100).toFixed(0) + '%';
  
  // Constraints KPIs
  document.getElementById('kpi-bwUtil').textContent = (fleetResults[i35].bwUtil * 100).toFixed(0) + '%';
  const totalPlat35 = fleetResults[i35].leoPlatforms + fleetResults[i35].meoPlatforms + 
                      fleetResults[i35].geoPlatforms + fleetResults[i35].cisPlatforms;
  const totalPlat50 = fleetResults[i50].leoPlatforms + fleetResults[i50].meoPlatforms + 
                      fleetResults[i50].geoPlatforms + fleetResults[i50].cisPlatforms;
  document.getElementById('kpi-plat35').textContent = (totalPlat35 / 1000).toFixed(0) + 'k';
  document.getElementById('kpi-plat50').textContent = (totalPlat50 / 1000).toFixed(0) + 'k';
  
  // Physics KPIs
  document.getElementById('kpi-leo').textContent = (sats[i35].powerKw / 1000).toFixed(1) + ' MW';
  document.getElementById('kpi-cis').textContent = (fleetResults[i35].cislunarPowerKw / 1000).toFixed(0) + ' MW';
  document.getElementById('kpi-mass').textContent = sats[i35].dryMass.toFixed(0) + ' kg';
  
  // Futures KPIs
  document.getElementById('kpi-crossAgg').textContent = agg.crossoverYear || 'Never';
  document.getElementById('kpi-crossBase').textContent = base.crossoverYear || 'Never';
  document.getElementById('kpi-crossCons').textContent = cons.crossoverYear || 'Never';
  
  // Toggle effects - droplet is always on
  document.getElementById('eff-droplet').className = 'toggle-effect active';
  document.getElementById('eff-fission').className = 'toggle-effect' + (P.fissionOn ? ' active' : '');
  document.getElementById('eff-smr').className = 'toggle-effect' + (P.smrOn ? ' active' : '');
  document.getElementById('eff-fusion').className = 'toggle-effect' + (P.fusionOn ? ' active' : '');
  
  // Core charts - LCOC with uncertainty
  charts.lcoc.data.datasets[0].data = agg.fleets.map(f => f.lcocEffective);
  charts.lcoc.data.datasets[1].data = base.fleets.map(f => f.lcocEffective);
  charts.lcoc.data.datasets[2].data = cons.fleets.map(f => f.lcocEffective);
  charts.lcoc.data.datasets[3].data = gnds.map(g => g.market);
  charts.lcoc.update();

  // World tab LCOC chart (same data as Core)
  charts.lcocWorld.data.datasets[0].data = agg.fleets.map(f => f.lcocEffective);
  charts.lcocWorld.data.datasets[1].data = base.fleets.map(f => f.lcocEffective);
  charts.lcocWorld.data.datasets[2].data = cons.fleets.map(f => f.lcocEffective);
  charts.lcocWorld.data.datasets[3].data = gnds.map(g => g.market);
  charts.lcocWorld.update();

  // Sandbox tab LCOC chart (same data as Core)
  charts.lcocSandbox.data.datasets[0].data = agg.fleets.map(f => f.lcocEffective);
  charts.lcocSandbox.data.datasets[1].data = base.fleets.map(f => f.lcocEffective);
  charts.lcocSandbox.data.datasets[2].data = cons.fleets.map(f => f.lcocEffective);
  charts.lcocSandbox.data.datasets[3].data = gnds.map(g => g.market);
  charts.lcocSandbox.update();

  // Inference cost ($/M tokens, Llama 70B equivalent)
  // Convert GPU-hr to $/M tokens: ~1 GPU-hr ≈ 10M tokens for Llama 70B
  // So $/M tokens ≈ LCOC / 10
  const tokensPerGpuHr = 10; // M tokens
  charts.inference.data.datasets[0].data = agg.fleets.map(f => f.lcocEffective / tokensPerGpuHr);
  charts.inference.data.datasets[1].data = base.fleets.map(f => f.lcocEffective / tokensPerGpuHr);
  charts.inference.data.datasets[2].data = cons.fleets.map(f => f.lcocEffective / tokensPerGpuHr);
  charts.inference.data.datasets[3].data = gnds.map(g => g.market / tokensPerGpuHr);
  charts.inference.update();
  
  // Fleet by shell
  charts.fleet.data.datasets[0].data = fleetResults.map(f => f.leoPowerTw);
  charts.fleet.data.datasets[1].data = fleetResults.map(f => f.meoPowerTw);
  charts.fleet.data.datasets[2].data = fleetResults.map(f => f.geoPowerTw);
  charts.fleet.data.datasets[3].data = fleetResults.map(f => f.cisPowerTw);
  charts.fleet.update();
  
  charts.carbon.data.datasets[0].data = sats.map(s => s.carbonPerTflop);
  charts.carbon.data.datasets[1].data = gnds.map(g => g.carbonPerTflop);
  charts.carbon.update();
  
  // Market charts
  charts.supplyDemand.data.datasets[0].data = gnds.map(g => g.demand);
  charts.supplyDemand.data.datasets[1].data = gnds.map(g => g.groundSupply);
  charts.supplyDemand.data.datasets[2].data = gnds.map(g => g.totalSupply);
  charts.supplyDemand.update();
  
  charts.scarcity.data.datasets[0].data = gnds.map(g => g.premium);
  charts.scarcity.update();
  
  charts.efficiency.data.datasets[0].data = sats.map(s => s.gflopsW);
  charts.efficiency.data.datasets[1].data = gnds.map(g => g.gflopsW);
  charts.efficiency.update();
  
  // Constraints charts - all 4 shells
  charts.shellUtil.data.datasets[0].data = fleetResults.map(f => f.leoUtil * 100);
  charts.shellUtil.data.datasets[1].data = fleetResults.map(f => f.meoUtil * 100);
  charts.shellUtil.data.datasets[2].data = fleetResults.map(f => f.geoUtil * 100);
  charts.shellUtil.data.datasets[3].data = fleetResults.map(f => f.cisUtil * 100);
  charts.shellUtil.update();
  
  charts.bwUtil.data.datasets[0].data = fleetResults.map(f => f.bwUtil * 100);
  charts.bwUtil.update();
  
  charts.bandwidth.data.datasets[0].data = fleetResults.map(f => f.bwAvailGbps / 1000); // Convert to Tbps for display
  charts.bandwidth.update();
  
  // Stranded capex penalty (1/sellableUtil - shows LCOC inflation from underutilization)
  charts.stranded.data.datasets[0].data = fleetResults.map(f => 1 / Math.max(0.01, f.sellableUtil || 1));
  charts.stranded.update();
  
  // Thermal: show radiator specific mass (kg/kW) - droplet makes this 50× lower
  charts.thermal.data.datasets[0].data = sats.map(s => getRadiatorMassPerMW(s.year, s.powerKw) / 1000);
  charts.thermal.update();
  
  charts.bottleneck.data.datasets[0].data = fleetResults.map(f => f.bottleneck === 'thermal' ? 1 : 0);
  charts.bottleneck.data.datasets[1].data = fleetResults.map(f => f.bottleneck === 'power' ? 1 : 0);
  charts.bottleneck.data.datasets[2].data = fleetResults.map(f => f.bottleneck === 'bandwidth' ? 1 : 0);
  charts.bottleneck.data.datasets[3].data = fleetResults.map(f => f.bottleneck === 'slots' ? 1 : 0);
  charts.bottleneck.data.datasets[4].data = fleetResults.map(f => f.bottleneck === 'demand' ? 1 : 0);
  charts.bottleneck.update();
  
  // Physics charts
  charts.power.data.datasets[0].data = sats.map(s => s.powerKw / 1000);
  charts.power.data.datasets[1].data = fleetResults.map(f => f.cislunarPowerKw / 1000);
  charts.power.update();
  
  charts.specPower.data.datasets[0].data = sats.map(s => s.specPower);
  charts.specPower.update();
  
  charts.mass.data.datasets[0].data = sats.map(s => s.mass.power);
  charts.mass.data.datasets[1].data = sats.map(s => s.mass.batt);
  charts.mass.data.datasets[2].data = sats.map(s => s.mass.comp);
  charts.mass.data.datasets[3].data = sats.map(s => s.mass.rad);
  charts.mass.data.datasets[4].data = sats.map(s => s.mass.struct);
  charts.mass.update();
  
  // Power budget: compute (68%), thermal management (~22%), housekeeping (~10%)
  // Power budget: compute, thermal management, housekeeping
  const compPct = P.computeFrac * 100;
  const thermalPct = (1 - P.computeFrac) * 0.7 * 100; // ~70% of non-compute goes to thermal
  const housePct = 100 - compPct - thermalPct;
  charts.powerBudget.data.datasets[0].data = YEARS.map(() => compPct);
  charts.powerBudget.data.datasets[1].data = YEARS.map(() => thermalPct);
  charts.powerBudget.data.datasets[2].data = YEARS.map(() => housePct);
  charts.powerBudget.update();
  
  charts.launch.data.datasets[0].data = YEARS.map(y => getLaunchCost(y));
  charts.launch.update();
  
  charts.dataRate.data.datasets[0].data = sats.map(s => s.dataRateGbps);
  charts.dataRate.update();
  
  // Reliability overhead by shell (SEU penalty as % overhead)
  charts.reliability.data.datasets[0].data = YEARS.map(y => (getShellRadiationEffects('leo', y).seuPenalty - 1) * 100);
  charts.reliability.data.datasets[1].data = YEARS.map(y => (getShellRadiationEffects('meo', y).seuPenalty - 1) * 100);
  charts.reliability.data.datasets[2].data = YEARS.map(y => (getShellRadiationEffects('geo', y).seuPenalty - 1) * 100);
  charts.reliability.data.datasets[3].data = YEARS.map(y => (getShellRadiationEffects('cislunar', y).seuPenalty - 1) * 100);
  charts.reliability.update();
  
  charts.erol.data.datasets[0].data = sats.map(s => s.erol);
  charts.erol.update();
  
  // Futures charts
  charts.lcocScenarios.data.datasets[0].data = agg.fleets.map(f => f.lcocEffective);
  charts.lcocScenarios.data.datasets[1].data = base.fleets.map(f => f.lcocEffective);
  charts.lcocScenarios.data.datasets[2].data = cons.fleets.map(f => f.lcocEffective);
  charts.lcocScenarios.data.datasets[3].data = base.gnds.map(g => g.market);
  charts.lcocScenarios.update();
  
  charts.carbonScenarios.data.datasets[0].data = agg.sats.map(s => s.carbonPerTflop);
  charts.carbonScenarios.data.datasets[1].data = base.sats.map(s => s.carbonPerTflop);
  charts.carbonScenarios.data.datasets[2].data = cons.sats.map(s => s.carbonPerTflop);
  charts.carbonScenarios.update();
  
  charts.effScenarios.data.datasets[0].data = agg.sats.map(s => s.gflopsW);
  charts.effScenarios.data.datasets[1].data = base.sats.map(s => s.gflopsW);
  charts.effScenarios.data.datasets[2].data = cons.sats.map(s => s.gflopsW);
  charts.effScenarios.update();
}

// ============================================
// EVENTS
// ============================================

document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  
  // Droplet is always on - just handle the year slider
  P.dropletOn = true;
  const dropletYearSlider = document.getElementById('dropletYear');
  const dropletYearVal = document.getElementById('v-dropletYear');
  if (dropletYearSlider) {
    dropletYearSlider.addEventListener('input', () => {
      P.dropletYear = parseInt(dropletYearSlider.value);
      if (dropletYearVal) dropletYearVal.textContent = P.dropletYear;
      update();
    });
  }
  
  // Other breakthroughs have toggles
  ['fission', 'fusion', 'smr'].forEach(tech => {
    const toggle = document.getElementById('tog-' + tech);
    const yearInput = document.getElementById('year-' + tech);
    if (!toggle) return;
    
    P[tech + 'On'] = toggle.checked;
    if (yearInput) yearInput.disabled = !toggle.checked;
    
    toggle.addEventListener('change', () => {
      P[tech + 'On'] = toggle.checked;
      if (yearInput) yearInput.disabled = !toggle.checked;
      update();
    });
    if (yearInput) {
      yearInput.addEventListener('change', () => {
        P[tech + 'Year'] = parseInt(yearInput.value);
        update();
      });
    }
  });
  
  const sliders = {
    emissivity: { p: 'emissivity', s: 0.01, f: v => v.toFixed(2) },
    opTemp: { p: 'opTemp', s: 1, f: v => v },
    solarEff: { p: 'solarEff', s: 0.01, f: v => Math.round(v * 100) },
    basePower: { p: 'basePower', s: 1, f: v => v },
    computeFrac: { p: 'computeFrac', s: 0.01, f: v => Math.round(v * 100) },
    battDens: { p: 'battDens', s: 1, f: v => v },
    satLife: { p: 'satLife', s: 1, f: v => v },
    radPen: { p: 'radPen', s: 0.01, f: v => Math.round(v * 100) },
    aiLearn: { p: 'aiLearn', s: 0.01, f: v => Math.round(v * 100) },
    launchCost: { p: 'launchCost', s: 1, f: v => v },
    launchLearn: { p: 'launchLearn', s: 0.01, f: v => Math.round(v * 100) },
    launchFloor: { p: 'launchFloor', s: 1, f: v => v },
    prodMult: { p: 'prodMult', s: 0.1, f: v => v.toFixed(1) },
    maintCost: { p: 'maintCost', s: 0.01, f: v => Math.round(v * 100) },
    waccOrbital: { p: 'waccOrbital', s: 0.01, f: v => Math.round(v * 100) },
    waccGround: { p: 'waccGround', s: 0.01, f: v => Math.round(v * 100) },
    bandwidth: { p: 'bandwidth', s: 1, f: v => v },
    bwGrowth: { p: 'bwGrowth', s: 0.01, f: v => Math.round(v * 100) },
    bwCost: { p: 'bwCost', s: 1, f: v => v },
    gbpsPerTflop: { p: 'gbpsPerTflop', s: 0.001, f: v => Math.round(v * 1000) }, // Display as Mbps
    groundPue: { p: 'groundPue', s: 0.01, f: v => v.toFixed(2) },
    energyCost: { p: 'energyCost', s: 0.001, f: v => v.toFixed(3) },
    energyEscal: { p: 'energyEscal', s: 0.01, f: v => Math.round(v * 100) },
    interconnect: { p: 'interconnect', s: 1, f: v => v },
    demand2025: { p: 'demand2025', s: 1, f: v => v },
    demandGrowth: { p: 'demandGrowth', s: 0.01, f: v => Math.round(v * 100) },
    orbitalEligibleShare: { p: 'orbitalEligibleShare', s: 0.01, f: v => Math.round(v * 100) },
    supply2025: { p: 'supply2025', s: 1, f: v => v },
    supplyGrowth: { p: 'supplyGrowth', s: 0.01, f: v => Math.round(v * 100) }
  };
  
  Object.entries(sliders).forEach(([id, cfg]) => {
    const el = document.getElementById(id);
    const val = document.getElementById('v-' + id);
    if (!el) return;
    el.addEventListener('input', () => {
      P[cfg.p] = parseFloat(el.value) * cfg.s;
      if (val) val.textContent = cfg.f(P[cfg.p]);
      update();
    });
  });
  
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.querySelector(`.tab-panel[data-tab="${tab.dataset.tab}"]`).classList.add('active');
    });
  });
  
  update();
});
</script>
</body>
</html>
